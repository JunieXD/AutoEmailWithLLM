{% extends "base.html" %}

{% block title %}邮件发送 - 自动套磁系统{% endblock %}

{% block extra_body_attrs %}data-tab="email-generator"{% endblock %}

{% block content %}
    <div class="container mt-4">
        
        <!-- 关键词替换说明 -->
        <div class="mb-3">
            <h6 class="text-info"><i class="bi bi-info-circle"></i> 关键词替换说明</h6>
            <div class="alert alert-info">
                <p class="mb-2"><strong>在邮件主题和内容中，您可以使用以下关键词，系统会自动替换：</strong></p>
                <div class="row">
                    <div class="col-md-6">
                        <ul class="list-unstyled mb-0">
                            <li><code>{{ '{{name}}' }}</code> → 教授姓名</li>
                            <li><code>{{ '{{date}}' }}</code> → 当前日期</li>
                            <li><code>{{ '{{university}}' }}</code> → 学校名称</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-unstyled mb-0">
                            <li><code>{{ '{{department}}' }}</code> → 学院名称</li>
                            <li><code>{{ '{{research_direction}}' }}</code> → 研究方向</li>
                        </ul>
                    </div>
                </div>
                <div class="mt-2">
                    <small class="text-muted">
                        <i class="bi bi-lightbulb"></i> 
                        示例："Dear {{ '{{name}}' }}, 关于{{ '{{research_direction}}' }}的学术合作咨询 - {{ '{{date}}' }}"
                    </small>
                </div>
            </div>
        </div>
        
        <!-- 使用已上传文档界面 -->
        <div id="document-usage-interface" class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-file-text"></i> 使用套磁信模板</h5>
                    </div>
                    <div class="card-body">
                        <form id="document-email-form">
                            <!-- 选择发送用户 -->
                            <div class="mb-4">
                                <h6 class="text-primary"><i class="bi bi-1-circle"></i> 选择发送用户</h6>
                                <div class="mb-3">
                                    <label for="doc-sender-user" class="form-label">发送人 *</label>
                                    <select class="form-select" id="doc-sender-user" onchange="handleDocSenderChange()">
                                        <option value="">请选择发送用户</option>
                                    </select>
                                    <div class="form-text">选择在用户管理中创建的用户作为邮件发送人</div>
                                </div>
                            </div>
                            
                            <!-- 选择套磁信文档 -->
                            <div class="mb-4" id="doc-document-selection" style="display: none;">
                                <h6 class="text-primary"><i class="bi bi-2-circle"></i> 选择套磁信文档</h6>
                                <div class="mb-3">
                                    <label class="form-label">选择文档 *</label>
                                    <div id="doc-user-documents-list"></div>
                                    <div class="form-text">选择当前发送用户已上传的套磁信文档</div>
                                </div>
                                
                                <!-- 文档预览 -->
                                <div id="doc-document-content" class="mt-3" style="display: none; max-height: 300px; overflow-y: auto; padding: 15px; border: 1px solid #dee2e6; border-radius: 0.375rem; background-color: #fff; font-family: 'Times New Roman', Times, serif; font-size: 12pt; line-height: 1.5; color: #000; word-wrap: break-word; overflow-wrap: break-word;"></div>
                            </div>
                            
                            <!-- 选择收件人教授 -->
                            <div class="mb-4" id="doc-professor-selection" style="display: none;">
                                <h6 class="text-primary"><i class="bi bi-3-circle"></i> 选择收件人教授</h6>
                                <div class="mb-3">
                                    <label class="form-label">发送模式 *</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="doc-selection-mode" id="doc-single-mode" value="single" checked onchange="handleDocSelectionModeChange(event)">
                                        <label class="btn btn-outline-primary" for="doc-single-mode">
                                            <i class="bi bi-person"></i> 单个发送
                                        </label>
                                        <input type="radio" class="btn-check" name="doc-selection-mode" id="doc-batch-mode" value="batch" onchange="handleDocSelectionModeChange(event)">
                                        <label class="btn btn-outline-primary" for="doc-batch-mode">
                                            <i class="bi bi-people"></i> 批量发送
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- 单个选择 -->
                                <div id="doc-single-selection" class="mb-3">
                                    <label for="doc-select-professor" class="form-label">选择教授 *</label>
                                    <div class="position-relative">
                                        <input type="text" class="form-control" id="doc-select-professor-input" 
                                               placeholder="输入教授姓名或学校进行搜索..." 
                                               autocomplete="off">
                                        <input type="hidden" id="doc-select-professor" name="doc-select-professor">
                                        <div id="doc-professor-dropdown" class="dropdown-menu w-100" style="max-height: 300px; overflow-y: auto; display: none;">
                                            <!-- 搜索结果将在这里显示 -->
                                        </div>
                                    </div>
                                    <div class="form-text">输入教授姓名或学校名称进行搜索</div>
                                </div>
                                
                                <!-- 批量选择 -->
                                <div id="doc-batch-selection" class="mb-3" style="display: none;">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="doc-select-university" class="form-label">选择学校 *</label>
                                            <select class="form-select" id="doc-select-university">
                                                <option value="">请选择学校</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="doc-select-department" class="form-label">选择学院 *</label>
                                            <select class="form-select" id="doc-select-department" disabled>
                                                <option value="">请先选择学校</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div id="doc-batch-professors-list" class="mt-3" style="display: none;">
                                        <!-- 教授列表将在这里动态生成 -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 邮件主题设置 -->
            <div class="mb-4" id="doc-subject-setting" style="display: none;">
                <h6 class="text-primary"><i class="bi bi-4-circle"></i> 邮件主题设置</h6>
                <div id="doc-subject-container" class="mb-3">
                    <label for="doc-email-subject" class="form-label">邮件主题 *</label>
                    <input type="text" class="form-control" id="doc-email-subject" 
                           placeholder="请输入邮件主题" required>
                    <div class="form-text">建议包含您的姓名或研究方向，让教授更容易识别</div>
                </div>
                

            </div>
            
            <!-- 附件选择 -->
            <div class="mb-4" id="doc-attachment-setting" style="display: none;">
                <h6 class="text-primary"><i class="bi bi-paperclip"></i> 附件选择</h6>
                <div class="mb-3">
                    <label class="form-label">选择要附加的文件（可多选）</label>
                    <div id="attachment-files-list" class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                        <div class="text-muted text-center py-3" id="no-files-message">
                            <i class="bi bi-files"></i>
                            <p class="mb-0 mt-2">暂无可选择的文件</p>
                            <small>请先在用户管理中上传文件</small>
                        </div>
                    </div>
                    <div class="form-text">
                        <i class="bi bi-info-circle"></i> 
                        选中的文件将作为邮件附件发送给教授
                    </div>
                </div>
            </div>
                            
                            <div class="d-grid gap-2" id="doc-actions-container" style="display: none;">
                                <button type="button" class="btn btn-success" id="doc-generate-email-btn" onclick="generateDocumentEmail()">
                                    <i class="bi bi-magic"></i> 生成邮件预览
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-envelope"></i> 邮件预览</h5>
                    </div>
                    <div class="card-body">
                        <div id="doc-email-preview">
                            <div class="text-muted text-center py-5">
                                <i class="bi bi-envelope-open display-4"></i>
                                <p class="mt-3">选择文档后邮件预览将显示在这里</p>
                            </div>
                        </div>
                        <!-- 发送按钮放在预览下方 -->
                        <div class="d-grid gap-2 mt-3" id="doc-send-container" style="display: none;">
                            <button type="button" class="btn btn-primary" id="doc-send-email-btn" onclick="sendDocumentEmails()">
                                <i class="bi bi-send"></i> 发送邮件
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 查看邮件内容模态框 -->
    <div class="modal fade" id="viewEmailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-envelope-open"></i> 邮件内容</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-sm-3"><strong>邮件主题:</strong></div>
                        <div class="col-sm-9" id="view-email-subject"></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-3"><strong>收件人:</strong></div>
                        <div class="col-sm-9" id="view-email-recipient"></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-3"><strong>发送时间:</strong></div>
                        <div class="col-sm-9" id="view-email-time"></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-3"><strong>邮件内容:</strong></div>
                        <div class="col-sm-9">
                            <div id="view-email-content" class="border rounded p-3" style="white-space: pre-wrap; max-height: 400px; overflow-y: auto;"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑邮件模态框 -->
    <div class="modal fade" id="editEmailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil"></i> 编辑邮件</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit-email-subject" class="form-label">邮件主题</label>
                        <input type="text" class="form-control" id="edit-email-subject">
                    </div>
                    <div class="mb-3">
                        <label for="edit-email-content" class="form-label">邮件内容</label>
                        <textarea class="form-control" id="edit-email-content" rows="15"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="window.EmailGenerator.saveEditedEmail()">保存</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}